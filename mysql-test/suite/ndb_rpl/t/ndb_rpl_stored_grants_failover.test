# This is a regression test for bug:
# RONDB-475 Mysqld Segfault when reversing replication role

# This bug causes mysqld on the replica to crash when replicating a GRANT
# NDB_STORED_USER statement while replication filtering is active e.g. by using
# --replicate-ignore-table.

#
# Master Cluster                   Slave Cluster
# --------------                   -------------
#     A   --> binlog --> replication     C
#     B                                  D
#

--source include/have_ndb.inc
--source suite/ndb_rpl/ndb_master-slave.inc

# Warning suppression on server D
connect(D,127.0.0.1,root,,,$SLAVE_MYPORT1,);
call mtr.add_suppression("You need to use --log-bin .*");
disconnect D;

# Activate replication filtering on server C
connection slave;
--source include/stop_slave.inc
CHANGE REPLICATION FILTER REPLICATE_IGNORE_TABLE = (test.nonexistent_table);
--source include/start_slave.inc

# Execute a GRANT NDB_STORED_USER statement on server A so that it replicates to
# server C
connection master;
CREATE USER 'ndb_u1'@'localhost' IDENTIFIED by 'pass1';
GRANT NDB_STORED_USER ON *.* TO 'ndb_u1'@'localhost';
--source include/wait_for_ndb_committed_to_binlog.inc
sync_slave_with_master;

# Make sure the replication worked
connection slave;
SELECT host, user FROM mysql.user WHERE user LIKE 'ndb_%';
SELECT grantee FROM information_schema.user_privileges WHERE privilege_type='NDB_STORED_USER' ORDER BY grantee;

# Cleanup
connection master;
DROP USER ndb_u1@localhost;
--source include/wait_for_ndb_committed_to_binlog.inc
sync_slave_with_master;

--let $rpl_only_running_threads= 1
--source include/rpl_end.inc
