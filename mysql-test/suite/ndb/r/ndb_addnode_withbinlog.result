show variables like 'log_bin';
Variable_name	Value
log_bin	ON
show variables like 'ndb_log_bin';
Variable_name	Value
ndb_log_bin	ON
Test 1 : Show that reorg of table being Binlogged does not result 
in any Binlog content
create table t1 (a int primary key, b varchar(100), c int, unique(c)) engine=ndb;
Insert 8192 rows
Show t1 distribution prior to reorg
TABLE_INFO
PartitionCount: 8
Add new nodes
Nodegroup 1 created
Show empty binlog prior to reorg
reset master;
select count(1), sum(inserts), sum(updates), sum(deletes) from mysql.ndb_binlog_index;
count(1)	sum(inserts)	sum(updates)	sum(deletes)
0	NULL	NULL	NULL
Reorg table to use new nodes
alter table t1 reorganize partition;
Show t1 distribution after reorg
TABLE_INFO
PartitionCount: 16
<<<<<<< HEAD
"Table t2 Partition info"
TABLE_INFO
PartitionCount: 16
"Table t3 Partition info"
TABLE_INFO
PartitionCount: 16
"Table t4 Partition info"
TABLE_INFO
PartitionCount: 16
"Table t5 Partition info"
TABLE_INFO
PartitionCount: 8
select count(0) as row_count from t6;
row_count
10000
"Table t6 Partition info"
TABLE_INFO
PartitionCount: 8
"Table t6 blob dat Partition info"
TABLE_INFO
PartitionCount: 8
"Table t6 blob txt Partition info"
TABLE_INFO
PartitionCount: 8
Table: test.t6
HashMap: DEFAULT-HASHMAP-3840-8

HashMap: DEFAULT-HASHMAP-3840-8

HashMap: DEFAULT-HASHMAP-3840-8

*  1006: Illegal reply from server
*        error: -2
ndbd(s)
id=1	LOCALHOST  (NDB_VERSION, Nodegroup: 0, *)
id=2	LOCALHOST  (NDB_VERSION, Nodegroup: 0)
id=3	LOCALHOST  (NDB_VERSION, Nodegroup: 1)
id=4	LOCALHOST  (NDB_VERSION, Nodegroup: 1)
ndb_mgmd(s)
id=5	LOCALHOST  (NDB_VERSION)
mysqld(s)
id=16	LOCALHOST  (NDB_VERSION)
id=32	LOCALHOST  (NDB_VERSION)
id=48	LOCALHOST  (NDB_VERSION)
id=49	LOCALHOST  (NDB_VERSION)
id=63	LOCALHOST  (NDB_VERSION)
id=127	LOCALHOST  (NDB_VERSION)
id=192 (not connected, accepting connect from localhost)
id=228 (not connected, accepting connect from localhost)
id=229 (not connected, accepting connect from localhost)
id=230 (not connected, accepting connect from localhost)
id=231 (not connected, accepting connect from localhost)
id=232 (not connected, accepting connect from localhost)
id=233 (not connected, accepting connect from localhost)
id=255 (not connected, accepting connect from localhost)
drop table t1,t2,t3,t4,t5,t6,t10;
||||||| be726b190f9
"Table t2 Partition info"
TABLE_INFO
PartitionCount: 16
"Table t3 Partition info"
TABLE_INFO
PartitionCount: 16
"Table t4 Partition info"
TABLE_INFO
PartitionCount: 16
"Table t5 Partition info"
TABLE_INFO
PartitionCount: 16
select count(0) as row_count from t6;
row_count
10000
"Table t6 Partition info"
TABLE_INFO
PartitionCount: 8
"Table t6 blob dat Partition info"
TABLE_INFO
PartitionCount: 8
"Table t6 blob txt Partition info"
TABLE_INFO
PartitionCount: 8
Table: test.t6
HashMap: DEFAULT-HASHMAP-3840-8

HashMap: DEFAULT-HASHMAP-3840-8

HashMap: DEFAULT-HASHMAP-3840-8

*  1006: Illegal reply from server
*        error: -2
ndbd(s)
id=1	LOCALHOST  (MYSQL_VERSION NDB_VERSION, Nodegroup: 0, *)
id=2	LOCALHOST  (MYSQL_VERSION NDB_VERSION, Nodegroup: 0)
id=3	LOCALHOST  (MYSQL_VERSION NDB_VERSION, Nodegroup: 1)
id=4	LOCALHOST  (MYSQL_VERSION NDB_VERSION, Nodegroup: 1)
ndb_mgmd(s)
id=5	LOCALHOST  (MYSQL_VERSION NDB_VERSION)
mysqld(s)
id=16	LOCALHOST  (MYSQL_VERSION NDB_VERSION)
id=32	LOCALHOST  (MYSQL_VERSION NDB_VERSION)
id=48	LOCALHOST  (MYSQL_VERSION NDB_VERSION)
id=49	LOCALHOST  (MYSQL_VERSION NDB_VERSION)
id=63	LOCALHOST  (MYSQL_VERSION NDB_VERSION)
id=127	LOCALHOST  (MYSQL_VERSION NDB_VERSION)
id=192 (not connected, accepting connect from localhost)
id=228 (not connected, accepting connect from localhost)
id=229 (not connected, accepting connect from localhost)
id=230 (not connected, accepting connect from localhost)
id=231 (not connected, accepting connect from localhost)
id=232 (not connected, accepting connect from localhost)
id=233 (not connected, accepting connect from localhost)
id=255 (not connected, accepting connect from localhost)
drop table t1,t2,t3,t4,t5,t6,t10;
=======
Show empty binlog after reorg
select count(1), sum(inserts), sum(updates), sum(deletes) from mysql.ndb_binlog_index;
count(1)	sum(inserts)	sum(updates)	sum(deletes)
0	NULL	NULL	NULL
Cleanup
drop table t1;
Drop Node Group 1 done
Test 2 : Show that reorg of table with concurrent writes
Results in Binlog content
Create table including Blobs for interest
create table test.t1 (a int auto_increment primary key,
b text,
c text,
d int, unique(d)) engine=ndb;
Load 100 rows first
Show t1 distribution prior to reorg
TABLE_INFO
PartitionCount: 8
Add new nodes
Nodegroup 1 created
reset master;
Show empty binlog prior to test
select count(1), sum(inserts), sum(updates), sum(deletes) from mysql.ndb_binlog_index;
count(1)	sum(inserts)	sum(updates)	sum(deletes)
0	NULL	NULL	NULL
Request reorg starting in 2 seconds
select sleep(2); alter table test.t1 reorganize partition;;
Start I/U/D load on table
Wait for reorg to complete
sleep(2)
0
Show t1 distribution after reorg
TABLE_INFO
PartitionCount: 16
Show Binlog content after reorg
Expect to see content
select count(epoch) > 100,  
sum(inserts) > 1000, 
sum(updates) > 1000, 
sum(deletes) > 1000 
from mysql.ndb_binlog_index;
count(epoch) > 100	sum(inserts) > 1000	sum(updates) > 1000	sum(deletes) > 1000
1	1	1	1
cleanup
drop table test.t1;
>>>>>>> 465ca823dcf
Drop Node Group 1 done
